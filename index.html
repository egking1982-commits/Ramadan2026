<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø±Ù…Ø¶Ø§Ù† Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ 1447</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a2a6c;
            --gold: #f2a900;
            --gold-light: #ffd700;
            --dark: #0f172a;
            --card: #1e293b;
            --red: #ef4444;
            --success: #22c55e;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: radial-gradient(circle at top, #1e293b, #0f172a);
            color: #f8fafc;
            margin: 0;
            min-height: 100vh;
            text-align: center;
        }

        .page { display: none; padding: 20px; max-width: 500px; margin: auto; animation: fadeIn 0.5s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .prayer-bar {
            background: linear-gradient(90deg, rgba(242, 169, 0, 0.15), transparent);
            border-right: 4px solid var(--gold);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        button {
            width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: none;
            font-weight: 700; cursor: pointer; font-family: 'Cairo';
            background: linear-gradient(135deg, var(--gold), #b8860b);
            color: #000; transition: 0.3s;
        }

        input, textarea {
            width: 90%; padding: 12px; margin: 8px 0; border-radius: 10px;
            border: 1px solid #334155; background: #0f172a; color: white; text-align: center;
        }

        .opt-btn { background: #334155; color: white; border: 1px solid #475569; }
        .leader-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #334155; }
        
        #explanation-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center;
        }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #991b1b); color: white; }
        .btn-secondary { background: #334155; color: white; }
    </style>
</head>
<body>

    <div id="explanation-modal">
        <div class="card" style="max-width: 80%;">
            <h2 id="result-title"></h2>
            <p id="explanation-text"></p>
            <button onclick="closeModal()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
        </div>
    </div>

    <div id="login-page" class="page active">
        <div class="card">
            <h1>ğŸŒ™</h1>
            <h2>Ø±Ù…Ø¶Ø§Ù† 1447</h2>
            <div id="countdown" style="color: var(--gold); margin-bottom: 15px;">â³ Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª...</div>
            <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
            <button onclick="handleLogin()">Ø¯Ø®ÙˆÙ„</button>
            <button style="background:none; color:var(--gold); border:1px solid var(--gold)" onclick="handleSignUp()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        </div>
    </div>

    <div id="main-page" class="page">
        <div class="prayer-bar" id="prayer-info">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ§Ù‚ÙŠØª Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯...</div>
        
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span id="user-display" style="font-weight: 800; color: var(--gold);"></span>
                <span>Ø§Ù„Ù†Ù‚Ø§Ø·: <b id="user-score">0</b></span>
            </div>
            <div id="ramadan-day-status" style="font-size: 0.8rem; margin-top: 5px; color: var(--gold);"></div>
            <div id="random-azkar" style="margin-top: 10px; font-style: italic; color: #94a3b8;"></div>
        </div>

        <div id="quiz-area" class="card">
            <h3 style="color: var(--gold);">â­ Ø³Ø¤Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…</h3>
            <h2 id="q-text" style="font-size: 1.2rem;"></h2>
            <div id="options-box"></div>
        </div>

        <div class="card">
            <h3>ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h3>
            <div id="leaderboard"></div>
        </div>

        <div id="admin-area" style="display:none;" class="card">
            <h3 style="color:var(--gold)">ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
            <div style="display: flex; gap: 5px;">
                <input type="number" id="adm-day" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ…">
                <button onclick="checkQuestion()" class="btn-secondary" style="width: 40%;">ÙØ­Øµ ğŸ”</button>
            </div>
            <textarea id="adm-text" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„"></textarea>
            <input type="text" id="adm-opts" placeholder="Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø§ÙØµÙ„ Ø¨Ù€ ,)">
            <input type="text" id="adm-correct" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©">
            <textarea id="adm-explain" placeholder="Ø§Ù„ØªÙØ³ÙŠØ±"></textarea>
            <button onclick="quickAdd()">Ø­ÙØ¸ / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„ âœ…</button>
            <button onclick="deleteQuestion()" class="btn-danger">Ø­Ø°Ù Ø³Ø¤Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… ğŸ—‘ï¸</button>
        </div>
        
        <button onclick="logout()" style="background:none; color:var(--red); border:1px solid var(--red); width: auto; padding: 8px 20px;">Ø®Ø±ÙˆØ¬</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, increment, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCKNwu6R3wjeHvWOrpiWkx5fnk0luEX_z4",
            authDomain: "ramadan-d4c32.firebaseapp.com",
            projectId: "ramadan-d4c32",
            storageBucket: "ramadan-d4c32.firebasestorage.app",
            messagingSenderId: "226219397241",
            appId: "1:226219397241:web:c9841a5806ea4402fe04a8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø±Ù…Ø¶Ø§Ù†ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® ---
        function getRamadanDay() {
            const startOfRamadan = new Date("Feb 18, 2026 00:00:00");
            const today = new Date();
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø£ÙŠØ§Ù…
            const diffTime = today - startOfRamadan;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays; // Ø¥Ø°Ø§ ÙƒØ§Ù† 1 ÙŠØ¹Ù†ÙŠ Ø£ÙˆÙ„ ÙŠÙˆÙ…ØŒ Ø¥Ø°Ø§ ÙƒØ§Ù† 0 Ø£Ùˆ Ø³Ø§Ù„Ø¨ ÙŠØ¹Ù†ÙŠ Ù„Ù… ÙŠØ¨Ø¯Ø£
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ---
        window.checkQuestion = async () => {
            const day = document.getElementById('adm-day').value;
            if(!day) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ…");
            const qSnap = await getDoc(doc(db, "questions", `day_${day}`));
            if(qSnap.exists()) {
                const data = qSnap.data();
                document.getElementById('adm-text').value = data.text;
                document.getElementById('adm-opts').value = data.options.join(',');
                document.getElementById('adm-correct').value = data.correct;
                document.getElementById('adm-explain').value = data.explanation;
                alert("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„.");
            } else { alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¤Ø§Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…."); }
        };

        window.deleteQuestion = async () => {
            const day = document.getElementById('adm-day').value;
            if(!day) return alert("Ø­Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡");
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ")) {
                await deleteDoc(doc(db, "questions", `day_${day}`));
                alert("ØªÙ… Ø§Ù„Ø­Ø°Ù");
                location.reload();
            }
        };

        window.quickAdd = async () => {
            const d = document.getElementById('adm-day').value;
            if(!d) return alert("Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ…");
            await setDoc(doc(db, "questions", `day_${d}`), {
                text: document.getElementById('adm-text').value,
                options: document.getElementById('adm-opts').value.split(','),
                correct: document.getElementById('adm-correct').value.trim(),
                explanation: document.getElementById('adm-explain').value
            });
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸!");
            location.reload();
        };

        // --- Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© ---
        async function fetchPrayers() {
            try {
                const res = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=Port%20Said&country=Egypt&method=5`);
                const data = await res.json();
                const t = data.data.timings;
                const prayers = { "Fajr": "Ø§Ù„ÙØ¬Ø±", "Dhuhr": "Ø§Ù„Ø¸Ù‡Ø±", "Asr": "Ø§Ù„Ø¹ØµØ±", "Maghrib": "Ø§Ù„Ù…ØºØ±Ø¨", "Isha": "Ø§Ù„Ø¹Ø´Ø§Ø¡" };
                const now = new Date();
                let next = "Ø§Ù„ÙØ¬Ø±"; 
                for (let [k, v] of Object.entries(prayers)) {
                    const [h, m] = t[k].split(':');
                    const pTime = new Date(); pTime.setHours(h, m, 0);
                    if (pTime > now) { next = `${v}: ${t[k]}`; break; }
                }
                document.getElementById('prayer-info').innerHTML = `ğŸ“ Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ | Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: <b>${next}</b>`;
            } catch (e) { document.getElementById('prayer-info').innerText = "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯: Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø­Ù…Ø¯Ù‡"; }
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø°ÙƒÙŠ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® ---
        async function loadQuestion(currentRamadanDay, lastSolvedDay) {
            const box = document.getElementById('options-box'); box.innerHTML = '';
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‚Ø¨Ù„ Ø±Ù…Ø¶Ø§Ù†
            if (currentRamadanDay <= 0) {
                document.getElementById('q-text').innerText = "Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ØªÙ†Ø·Ù„Ù‚ Ø£ÙˆÙ„ ÙŠÙˆÙ… Ø±Ù…Ø¶Ø§Ù†.. ÙƒÙ† Ù…Ø³ØªØ¹Ø¯Ø§Ù‹! ğŸŒ™";
                return;
            }

            document.getElementById('ramadan-day-status').innerText = `ğŸŒ™ Ù†Ø­Ù† Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„ÙŠÙˆÙ… ${currentRamadanDay} Ù…Ù† Ø±Ù…Ø¶Ø§Ù†`;

            const qSnap = await getDoc(doc(db, "questions", `day_${currentRamadanDay}`));
            
            if (qSnap.exists()) {
                const q = qSnap.data();
                document.getElementById('q-text').innerText = q.text;
                
                // ÙØ­Øµ Ù‡Ù„ Ø­Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø¤Ø§Ù„ Ø§Ù„ÙŠÙˆÙ… (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ)
                const isSolved = (lastSolvedDay === currentRamadanDay);

                q.options.forEach(opt => {
                    const b = document.createElement('button');
                    b.className = 'opt-btn';
                    b.innerText = opt.trim();
                    if(isSolved) b.disabled = true;
                    
                    b.onclick = async () => {
                        const allBtns = box.querySelectorAll('button');
                        allBtns.forEach(btn => btn.disabled = true);

                        const isCorrect = opt.trim() === q.correct.trim();
                        
                        // ØªØ³Ø¬ÙŠÙ„ Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ù… Ø¨Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
                        await updateDoc(doc(db, "users", auth.currentUser.uid), { 
                            lastSolved: currentRamadanDay 
                        });

                        if(isCorrect) {
                            await updateDoc(doc(db, "users", auth.currentUser.uid), { score: increment(10) });
                            document.getElementById('user-score').innerText = parseInt(document.getElementById('user-score').innerText) + 10;
                        }

                        showResult(isCorrect, q.explanation);
                        document.getElementById('q-text').innerHTML += isCorrect ? "<br><small style='color:var(--success)'>âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</small>" : "<br><small style='color:var(--red)'>âŒ Ø§Ù†ØªÙ‡Øª Ù…Ø­Ø§ÙˆÙ„ØªÙƒ</small>";
                    };
                    box.appendChild(b);
                });
                if(isSolved) document.getElementById('q-text').innerHTML += "<br><small style='color:var(--gold)'>âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ø§ÙˆÙ„ØªÙƒ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</small>";
            } else {
                document.getElementById('q-text').innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø³Ø¤Ø§Ù„ Ø§Ù„ÙŠÙˆÙ….. Ø§Ù†ØªØ¸Ø±ÙˆÙ†Ø§!";
            }
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('main-page').style.display = 'block';
                const userRef = doc(db, "users", user.uid);
                let snap = await getDoc(userRef);
                if (!snap.exists()) {
                    const role = (user.email === "m@m.com") ? "admin" : "user";
                    await setDoc(userRef, { email: user.email, score: 0, role: role, lastSolved: 0 });
                    snap = await getDoc(userRef);
                }
                const data = snap.data();
                document.getElementById('user-display').innerText = "Ø£Ù‡Ù„Ø§Ù‹ " + user.email.split('@')[0];
                document.getElementById('user-score').innerText = data.score;

                if(user.email === "m@m.com" && data.role === "admin") {
                    document.getElementById('admin-area').style.display = 'block';
                }
                
                // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
                const ramadanDay = getRamadanDay();
                loadQuestion(ramadanDay, data.lastSolved);
                
                loadLeaderboard();
                fetchPrayers();
            } else {
                document.getElementById('main-page').style.display = 'none';
                document.getElementById('login-page').style.display = 'block';
            }
        });

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        async function loadLeaderboard() {
            const q = query(collection(db, "users"), orderBy("score", "desc"), limit(5));
            const snap = await getDocs(q);
            const div = document.getElementById('leaderboard'); div.innerHTML = '';
            snap.forEach((doc, i) => {
                const d = doc.data();
                div.innerHTML += `<div class="leader-item"><span>#${i+1} ${d.email.split('@')[0]}</span> <b>${d.score}</b></div>`;
            });
        }

        function updateCountdown() {
            const target = new Date("Feb 18, 2026 00:00:00").getTime();
            const now = new Date().getTime();
            const diff = target - now;
            if (diff <= 0) { document.getElementById("countdown").innerText = "Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…!"; return; }
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            document.getElementById("countdown").innerText = `Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„Ù‰ Ø±Ù…Ø¶Ø§Ù†: ${days} ÙŠÙˆÙ… Ùˆ ${hours} Ø³Ø§Ø¹Ø©`;
        }
        setInterval(updateCountdown, 1000);

        window.handleLogin = () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(() => alert("Ø®Ø·Ø£ Ø¯Ø®ÙˆÙ„"));
        window.handleSignUp = () => createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(() => alert("Ø®Ø·Ø£ ØªØ³Ø¬ÙŠÙ„"));
        window.showResult = (correct, exp) => {
            document.getElementById('result-title').innerText = correct ? "Ø£Ø­Ø³Ù†Øª! ğŸ‰" : "Ø®Ø·Ø£! ğŸŒ™";
            document.getElementById('result-title').style.color = correct ? "var(--success)" : "var(--red)";
            document.getElementById('explanation-text').innerText = exp;
            document.getElementById('explanation-modal').style.display = 'flex';
        };
        window.closeModal = () => document.getElementById('explanation-modal').style.display = 'none';
        window.logout = () => signOut(auth).then(() => location.reload());
        
        const azkar = ["Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡", "Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡", "Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡", "Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±"];
        setInterval(() => { document.getElementById('random-azkar').innerText = azkar[Math.floor(Math.random()*azkar.length)]; }, 5000);
    </script>
</body>
</html>

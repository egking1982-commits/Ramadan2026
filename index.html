<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø±Ù…Ø¶Ø§Ù† Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ 1447</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a2a6c; --gold: #f2a900; --dark: #0f172a; --card: #1e293b; --red: #ef4444; --success: #22c55e; --blue: #3b82f6;
        }
        body {
            font-family: 'Cairo', sans-serif; background: radial-gradient(circle at top, #1e293b, #0f172a);
            color: #f8fafc; margin: 0; min-height: 100vh; text-align: center; overflow-x: hidden;
        }
        .page { display: none; padding: 20px; max-width: 500px; margin: auto; animation: fadeIn 0.5s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card {
            background: var(--card); padding: 20px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);
        }
        .prayer-bar {
            background: linear-gradient(90deg, rgba(242, 169, 0, 0.15), transparent);
            border-right: 4px solid var(--gold); padding: 12px; border-radius: 10px; margin-bottom: 15px; font-weight: bold;
            transition: 0.3s;
        }
        .prayer-near { animation: pulseGold 1.5s infinite; border-color: var(--red); }
        @keyframes pulseGold { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        button {
            width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: none;
            font-weight: 700; cursor: pointer; font-family: 'Cairo';
            background: linear-gradient(135deg, var(--gold), #b8860b); color: #000; transition: 0.3s;
        }
        input, textarea {
            width: 95%; padding: 12px; margin: 8px 0; border-radius: 10px;
            border: 1px solid #334155; background: #0f172a; color: white; text-align: center; font-family: 'Cairo';
        }
        .user-admin-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; border-bottom: 1px solid #334155; font-size: 0.85rem;
        }
        .btn-small { width: auto; padding: 5px 8px; font-size: 0.7rem; margin: 0; color: white; }
        .btn-red { background: var(--red); }
        .btn-blue { background: var(--blue); }
        
        /* Toast Notifications */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 400px; }
        .toast { padding: 15px 20px; border-radius: 12px; margin-bottom: 10px; color: white; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s ease-out; display: flex; align-items: center; justify-content: center; gap: 10px; }
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast-success { background: var(--success); }
        .toast-error { background: var(--red); }
        .toast-info { background: var(--blue); }
        .toast-gold { background: var(--gold); color: #000; }

        .wait-box { padding: 15px; border: 1px dashed var(--gold); border-radius: 15px; background: rgba(242,169,0,0.05); margin-top: 10px; color: var(--gold); }
        #countdown, #quiz-timer { font-family: monospace; font-size: 1.1rem; letter-spacing: 1px; }
        .leaderboard-item { display: flex; justify-content: space-between; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 5px; border-right: 4px solid var(--gold); }
        .my-rank { background: rgba(242, 169, 0, 0.1); border: 1px solid var(--gold); }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="login-page" class="page active">
        <div class="card">
            <h1>ğŸŒ™</h1>
            <h2>Ø±Ù…Ø¶Ø§Ù† Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ 1447</h2>
            <div style="color: #94a3b8; font-size: 0.8rem;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„Ù‰ Ø´Ù‡Ø± Ø±Ù…Ø¶Ø§Ù†:</div>
            <div id="countdown" style="margin-bottom: 20px; color: var(--gold); font-weight: bold;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</div>
            <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
            <button onclick="handleLogin()">Ø¯Ø®ÙˆÙ„</button>
            <button style="background:none; color:var(--gold); border:1px solid var(--gold)" onclick="handleSignUp()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        </div>
    </div>

    <div id="main-page" class="page">
        <div class="prayer-bar" id="prayer-info">ğŸ“ Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ | Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...</div>
        
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span id="user-display" style="color: var(--gold); font-weight: 800;"></span>
                <span>Ø§Ù„Ù†Ù‚Ø§Ø·: <b id="user-score">0</b></span>
            </div>
            <div id="random-azkar" style="margin-top: 10px; font-style: italic; color: #94a3b8;"></div>
        </div>

        <div id="quiz-area" class="card">
            <h3 style="color: var(--gold);">â­ Ø³Ø¤Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…</h3>
            <div id="q-text"></div>
            <div id="options-box" style="margin-top: 10px;"></div>
        </div>

        <div class="card">
            <h3 style="color: var(--gold); margin-bottom: 15px;">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù (Top 5)</h3>
            <div id="leaderboard-list"></div>
        </div>

        <div id="admin-area" style="display:none;" class="card">
            <h3 style="color:var(--gold)">ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                <h4>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</h4>
                <input type="text" id="user-search" placeholder="Ø¨Ø­Ø«..." oninput="filterUsers()">
                <div id="users-admin-list" style="max-height: 200px; overflow-y: auto;"></div>
                <button onclick="resetAllScores()" style="background: #f59e0b; font-size: 0.8rem; padding: 8px;">ØªØµÙÙŠØ± Ù†Ù‚Ø§Ø· Ø§Ù„Ø¬Ù…ÙŠØ¹ âš ï¸</button>
            </div>
            <div style="text-align: right;">
                <h4>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h4>
                <input type="number" id="adm-day" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ…">
                <textarea id="adm-text" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„"></textarea>
                <input type="text" id="adm-opts" placeholder="Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø§ÙØµÙ„ Ø¨Ù€ ,)">
                <input type="text" id="adm-correct" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©">
                <button onclick="quickAdd()">Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„ âœ…</button>
            </div>
        </div>
        
        <button onclick="logout()" style="background:none; color:var(--red); border:1px solid var(--red); width: auto; font-size: 0.8rem; padding: 8px 20px;">Ø®Ø±ÙˆØ¬</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, increment, collection, getDocs, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCKNwu6R3wjeHvWOrpiWkx5fnk0luEX_z4",
            authDomain: "ramadan-d4c32.firebaseapp.com",
            projectId: "ramadan-d4c32",
            storageBucket: "ramadan-d4c32.firebasestorage.app",
            messagingSenderId: "226219397241",
            appId: "1:226219397241:web:c9841a5806ea4402fe04a8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const RAMADAN_START = new Date("Feb 18, 2026 00:00:00").getTime();
        const azkarList = ["Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø­Ù…Ø¯Ù‡","Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡","Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡","Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±","Ù„Ø§ Ø­ÙˆÙ„ ÙˆÙ„Ø§ Ù‚ÙˆØ© Ø¥Ù„Ø§ Ø¨Ø§Ù„Ù„Ù‡","Ø­Ø³Ø¨Ù†Ø§ Ø§Ù„Ù„Ù‡ ÙˆÙ†Ø¹Ù… Ø§Ù„ÙˆÙƒÙŠÙ„","Ù„Ø§ Ø§Ù„Ù‡ Ø§Ù„Ø§ Ø§Ù†Øª Ø³Ø¨Ø­Ø§Ù† Ø§Ù†ÙŠ ÙƒÙ†Øª Ù…Ù† Ø§Ù„Ø¸Ø§Ù„Ù…ÙŠÙ†"];
        const ADMIN_EMAIL = "m@m.com";

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Toast) ---
        function showToast(msg, type = "info") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // --- Ø¹Ø¯Ø§Ø¯ Ø±Ù…Ø¶Ø§Ù† ---
        function runCountdown() {
            const now = new Date().getTime();
            const diff = RAMADAN_START - now;
            const el = document.getElementById("countdown");
            if (!el) return;
            if (diff > 0) {
                const days = Math.floor(diff / 86400000);
                const hrs = Math.floor((diff % 86400000) / 3600000);
                const mins = Math.floor((diff % 3600000) / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                el.innerHTML = `${days} ÙŠÙˆÙ… Ùˆ ${hrs}:${mins}:${secs}`;
            } else { el.innerHTML = "ğŸŒ™ Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…!"; }
        }
        setInterval(runCountdown, 1000);

        // --- Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù (Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¢Ø¯Ù…Ù†) ---
        async function loadLeaderboard() {
            const q = query(
                collection(db, "users"), 
                where("role", "==", "user"), // Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø£ÙŠ Ø­Ø³Ø§Ø¨ Ø¨Ø±ØªØ¨Ø© Ø¢Ø¯Ù…Ù†
                orderBy("score", "desc"), 
                limit(5)
            );
            const snap = await getDocs(q);
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = snap.docs.map((d, i) => {
                const isMe = d.id === auth.currentUser?.uid;
                return `
                <div class="leaderboard-item ${isMe ? 'my-rank' : ''}">
                    <span>${i+1}. ${d.data().email.split('@')[0]} ${isMe ? '(Ø£Ù†Øª)' : ''}</span>
                    <span style="color:var(--gold)">${d.data().score || 0} Ù†Ù‚Ø·Ø©</span>
                </div>
            `}).join('');
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† ---
        let allUsers = [];
        async function loadAdminUsers() {
            const snap = await getDocs(collection(db, "users"));
            allUsers = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderUserList(allUsers);
        }
        function renderUserList(list) {
            document.getElementById('users-admin-list').innerHTML = list.map(u => `
                <div class="user-admin-item">
                    <span>${u.email.split('@')[0]} (${u.score || 0})</span>
                    <div>
                        <button class="btn-small btn-blue" onclick="forceResetPass('${u.id}')">ØªØµÙÙŠØ± PASS</button>
                        <button class="btn-small btn-red" onclick="deleteUser('${u.id}')">Ø­Ø°Ù</button>
                    </div>
                </div>
            `).join('');
        }

        // --- Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„ÙˆÙ‚Øª ---
        function updateQuizTimer() {
            const now = new Date();
            const target = new Date();
            target.setHours(20, 30, 0); 
            const diff = target - now;
            const timerEl = document.getElementById('quiz-timer');
            if (timerEl && diff > 0) {
                const hrs = Math.floor(diff / 3600000);
                const mins = Math.floor((diff % 3600000) / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                timerEl.innerHTML = `Ù…ØªØ¨Ù‚ÙŠ: ${hrs}:${mins}:${secs}`;
            } else if (diff <= 0) { location.reload(); }
        }

        async function setupQuiz(lastSolved) {
            const qText = document.getElementById('q-text');
            const box = document.getElementById('options-box');
            const rDay = Math.ceil((new Date().getTime() - RAMADAN_START) / 86400000);
            if (rDay <= 0) { qText.innerText = "Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ØªÙ†Ø·Ù„Ù‚ Ø£ÙˆÙ„ Ø±Ù…Ø¶Ø§Ù†."; return; }
            
            const now = new Date();
            const targetTime = 20 * 60 + 30; 
            const currentTime = now.getHours() * 60 + now.getMinutes();

            if (currentTime < targetTime) {
                qText.innerHTML = `<div class="wait-box">ÙŠÙ†Ø´Ø± Ø³Ø¤Ø§Ù„ Ø§Ù„ÙŠÙˆÙ… 8:30 Ù…<br><span id="quiz-timer"></span></div>`;
                setInterval(updateQuizTimer, 1000);
                return;
            }

            const qSnap = await getDoc(doc(db, "questions", `day_${rDay}`));
            if(qSnap.exists()) {
                const q = qSnap.data(); qText.innerText = q.text; box.innerHTML = '';
                q.options.forEach(opt => {
                    const b = document.createElement('button'); b.innerText = opt;
                    if(lastSolved === rDay) b.disabled = true;
                    b.onclick = async () => {
                        const userRef = doc(db, "users", auth.currentUser.uid);
                        await updateDoc(userRef, {lastSolved: rDay});
                        if(opt.trim() === q.correct.trim() && auth.currentUser.email !== ADMIN_EMAIL) {
                            await updateDoc(userRef, {score: increment(10)});
                            showToast("Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! +10 Ù†Ù‚Ø§Ø· ğŸŒŸ", "success");
                        } else {
                            showToast("Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© Ø£Ùˆ Ø­Ø³Ø§Ø¨ Ù…Ø¯ÙŠØ± ğŸŒ™", "error");
                        }
                        setTimeout(() => location.reload(), 2000);
                    };
                    box.appendChild(b);
                });
                if(lastSolved === rDay) qText.innerHTML += "<br><small style='color:var(--success)'>ØªÙ…Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© âœ…</small>";
            }
        }

        // --- Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, "users", user.uid);
                let snap = await getDoc(userRef);
                const role = user.email === ADMIN_EMAIL ? "admin" : "user";
                if(!snap.exists()) {
                    await setDoc(userRef, {email: user.email, score: 0, role: role, lastSolved: 0, forceReset: false});
                    snap = await getDoc(userRef);
                }
                const data = snap.data();
                if(data.forceReset) {
                    await updatePassword(user, "123456");
                    await updateDoc(userRef, { forceReset: false });
                    showToast("ØªÙ… ØªØµÙÙŠØ± ÙƒÙ„Ù…Ø© Ø³Ø±Ùƒ Ø¥Ù„Ù‰ 123456", "info");
                }
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('main-page').style.display = 'block';
                document.getElementById('user-display').innerText = data.email.split('@')[0];
                document.getElementById('user-score').innerText = data.score;
                if(data.role === "admin") { document.getElementById('admin-area').style.display = 'block'; loadAdminUsers(); }
                setupQuiz(data.lastSolved);
                loadLeaderboard();
                fetchPrayers();
                showToast(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${data.email.split('@')[0]} ğŸŒ™`, "gold");
                setInterval(() => { document.getElementById('random-azkar').innerText = azkarList[Math.floor(Math.random() * azkarList.length)]; }, 5000);
            } else {
                document.getElementById('login-page').style.display = 'block';
                document.getElementById('main-page').style.display = 'none';
            }
        });

        // --- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© ---
        window.handleLogin = () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(()=>showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error"));
        window.handleSignUp = () => createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(()=>showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„", "error"));
        window.logout = () => signOut(auth).then(() => location.reload());
        window.forceResetPass = async (id) => { if(confirm("ØªØµÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ")) { await updateDoc(doc(db, "users", id), {forceReset:true}); showToast("ØªÙ…Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©", "info"); } };
        window.deleteUser = async (id) => { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) { await deleteDoc(doc(db, "users", id)); loadAdminUsers(); showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù", "error"); } };
        window.resetAllScores = async () => { if(confirm("ØªØµÙÙŠØ± Ø§Ù„ÙƒÙ„ØŸ")) { const s = await getDocs(collection(db, "users")); await Promise.all(s.docs.map(d => updateDoc(doc(db, "users", d.id), {score:0}))); location.reload(); } };
        window.filterUsers = () => renderUserList(allUsers.filter(u => u.email.toLowerCase().includes(document.getElementById('user-search').value.toLowerCase())));
        window.quickAdd = async () => {
            await setDoc(doc(db, "questions", `day_${document.getElementById('adm-day').value}`), {
                text: document.getElementById('adm-text').value,
                options: document.getElementById('adm-opts').value.split(','),
                correct: document.getElementById('adm-correct').value.trim()
            });
            showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…", "success");
        };

        async function fetchPrayers() {
            try {
                const res = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=Port%20Said&country=Egypt&method=5`);
                const json = await res.json();
                const p = json.data.timings;
                const now = new Date();
                const cur = now.getHours() * 60 + now.getMinutes();
                const sch = [{n:"Ø§Ù„ÙØ¬Ø±",t:p.Fajr},{n:"Ø§Ù„Ø¸Ù‡Ø±",t:p.Dhuhr},{n:"Ø§Ù„Ø¹ØµØ±",t:p.Asr},{n:"Ø§Ù„Ù…ØºØ±Ø¨",t:p.Maghrib},{n:"Ø§Ù„Ø¹Ø´Ø§Ø¡",t:p.Isha}];
                let next = sch.find(s => (parseInt(s.t.split(':')[0])*60 + parseInt(s.t.split(':')[1])) > cur) || sch[0];
                
                const nextTime = parseInt(next.t.split(':')[0])*60 + parseInt(next.t.split(':')[1]);
                const diff = nextTime - cur;
                
                const bar = document.getElementById('prayer-info');
                bar.innerHTML = `ğŸ“ Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ | Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: <b>${next.n} (${next.t})</b>`;
                
                if(diff > 0 && diff <= 15) {
                    bar.classList.add('prayer-near');
                    showToast(`Ø§Ù‚ØªØ±Ø¨ Ù…ÙˆØ¹Ø¯ ØµÙ„Ø§Ø© ${next.n} ğŸ•Œ`, "gold");
                } else {
                    bar.classList.remove('prayer-near');
                }
            } catch (e) {}
        }
    </script>
</body>
</html>
